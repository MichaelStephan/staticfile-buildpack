#!/bin/sh
# http://jamie.curle.io/blog/compiling-nginx-ubuntu/
# https://github.com/cloudfoundry-community/nginx-buildpack#building-the-nginx-package
set -e
set -x

pcre_version=8.35
nginx_version=1.7.8
lua_jit_version=2.0.3
ngx_devel_kit_version=0.2.19
lua_nginx_version=0.9.13
nginx_crowd_lua_version=0.0.1

sudo apt-get update
sudo apt-get install -fy build-essential zlib1g-dev
sudo apt-get install -fy git-core

src=~/src
build=/app/nginx
target=/vagrant/vendor
lua_build=/app/lua
nginx_crowd_lua_build=/app/nginx-crowd-lua

rm -rf $build && mkdir -p $build
mkdir -p $src
cd $src

wget http://luajit.org/download/LuaJIT-$lua_jit_version.tar.gz
tar xzvf LuaJIT-$lua_jit_version.tar.gz
cd LuaJIT-$lua_jit_version
sudo make install PREFIX=$lua_build
sudo make clean
cd $src

wget https://github.com/simpl/ngx_devel_kit/archive/v$ngx_devel_kit_version.tar.gz
tar xvzf v$ngx_devel_kit_version.tar.gz
cd $src

wget https://github.com/openresty/lua-nginx-module/archive/v$lua_nginx_version.tar.gz
tar xzvf v$lua_nginx_version.tar.gz
cd $src

wget ftp://ftp.csx.cam.ac.uk/pub/software/programming/pcre/pcre-$pcre_version.tar.gz
tar -xzvf pcre-$pcre_version.tar.gz
cd pcre-$pcre_version/
./configure --prefix=$build
make
sudo make install
sudo ldconfig # this is important otherwise nginx will compile but fail to load

cd $src
wget http://nginx.org/download/nginx-$nginx_version.tar.gz
tar -xvzf nginx-$nginx_version.tar.gz
cd nginx-$nginx_version

export LUAJIT_LIB=$lua_build/lib
export LUAJIT_INC=$lua_build/include/luajit-2.0
./configure --prefix=$build --with-pcre=$src/pcre-$pcre_version --with-http_ssl_module --add-module=$src/ngx_devel_kit-$ngx_devel_kit_version --add-module=$src/lua-nginx-module-$lua_nginx_version 
 
make
sudo make install

# Remove extras (help, utilities etc)

sudo rm -rf /app/nginx/bin
sudo rm -rf /app/nginx/sbin/nginx.old
sudo rm -rf /app/nginx/include
sudo rm -rf /app/nginx/share

cd $src
rm -rf nginx-crowd-lua
git clone https://github.com/MichaelStephan/nginx-crowd-lua
mv nginx-crowd-lua $nginx_crowd_lua_build

# Archive it all up
mkdir -p $target
cd /app 
tar -zcvpf $target/nginx-$nginx_version.tar.gz nginx/
tar -zcvpf $target/luajit-$lua_jit_version.tar.gz lua/
tar -zcvpf $target/nginx-crowd-lua-$nginx_crowd_lua_version.tar.gz nginx-crowd-lua/
